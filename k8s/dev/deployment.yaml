apiVersion: apps/v1
kind: Deployment
metadata:
  name: workload-app
  namespace: java-app-dev
  labels:
    app: workload-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: workload-app
  template:
    metadata:
      labels:
        app: workload-app
      annotations:
        inject-java: "true"
    spec:
      shareProcessNamespace: true
      volumes:
        - name: tools
          emptyDir: {}
        - name: otel
          emptyDir: {}
        - name: pyroscope
          emptyDir: {}
      initContainers:
        - name: fetch-async-profiler
          image: curlimages/curl:8.12.1
          command:
            - sh
            - -lc
            - |
              set -euo pipefail
              echo "Downloading async-profiler v4.3 (linux-arm64)..."
              curl -fsSL -o /tmp/async-profiler.tar.gz \
                https://github.com/async-profiler/async-profiler/releases/download/v4.3/async-profiler-4.3-linux-arm64.tar.gz
              mkdir -p /opt/async-profiler
              tar -xzf /tmp/async-profiler.tar.gz -C /opt/async-profiler --strip-components=1
              /opt/async-profiler/bin/asprof --version
          volumeMounts:
            - name: tools
              mountPath: /opt/async-profiler
        - name: fetch-otel-javaagent
          image: curlimages/curl:8.12.1
          env:
            - name: INJECT_JAVA
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['inject-java']
          command:
            - sh
            - -lc
            - |
              set -euo pipefail
              if [ "${INJECT_JAVA:-}" != "true" ]; then
                echo "inject-java is not 'true'; skipping OpenTelemetry Java agent download."
                exit 0
              fi
              echo "Downloading OpenTelemetry Java agent (latest)..."
              curl -fsSL -o /otel/opentelemetry-javaagent.jar \
                https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar
              ls -lh /otel/opentelemetry-javaagent.jar
          volumeMounts:
            - name: otel
              mountPath: /otel
        - name: fetch-pyroscope-javaagent
          image: curlimages/curl:8.12.1
          env:
            - name: INJECT_JAVA
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['inject-java']
          command:
            - sh
            - -lc
            - |
              set -euo pipefail
              if [ "${INJECT_JAVA:-}" != "true" ]; then
                echo "inject-java is not 'true'; skipping Pyroscope Java agent download."
                exit 0
              fi
              echo "Downloading Pyroscope Java agent (v2.3.0)..."
              curl -fsSL -o /pyroscope/pyroscope.jar \
                https://github.com/grafana/pyroscope-java/releases/download/v2.3.0/pyroscope.jar
              ls -lh /pyroscope/pyroscope.jar
          volumeMounts:
            - name: pyroscope
              mountPath: /pyroscope
      containers:
        - name: app
          image: workload-app:dev
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
          env:
            - name: CLUSTER_NAME
              value: docker-desktop
            - name: INJECT_JAVA
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['inject-java']
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            # Applied only when INJECT_JAVA == "true"
            - name: JAVAAGENT_ARGS
              value: >-
                -javaagent:/otel/opentelemetry-javaagent.jar
                -javaagent:/pyroscope/pyroscope.jar
                -Dotel.service.name=workload-app
                -Dotel.metrics.exporter=none
                -Dotel.logs.exporter=none
                -Dotel.traces.exporter=none
                -XX:+UnlockDiagnosticVMOptions
                -XX:+DebugNonSafepoints
                -XX:+PreserveFramePointer
                -XX:MaxInlineLevel=0
                -XX:-Inline
            - name: PYROSCOPE_APPLICATION_NAME
              value: workload-app
            # Send profiles to Alloy, Alloy forwards to Pyroscope
            - name: PYROSCOPE_SERVER_ADDRESS
              value: http://alloy.observability.svc.cluster.local:9999
            # Wall-clock profiling: shows time spent sleeping/waiting/blocking.
            # Values (JFR): itimer | cpu | wall
            - name: PYROSCOPE_PROFILER_EVENT
              value: itimer
            # Allocation profiling (controls overhead): e.g. 512k, 1m, 2m...
            - name: PYROSCOPE_PROFILER_ALLOC
              value: 1m
            # Keep only allocations that are still alive at the end of the profiling session.
            - name: PYROSCOPE_ALLOC_LIVE
              value: "true"
            # Optional: still allow extra flags via existing Dockerfile behavior
            - name: JAVA_OPTS
              value: ""
          command:
            - sh
            - -lc
            - |
              set -eu
              if [ "${INJECT_JAVA:-}" = "true" ]; then
                if [ -f /otel/opentelemetry-javaagent.jar ] && [ -f /pyroscope/pyroscope.jar ]; then
                  # Add dynamic labels so all pods/namespaces are filterable in Grafana/Pyroscope.
                  # If you set PYROSCOPE_LABELS manually, we just append pod metadata.
                  if [ -n "${PYROSCOPE_LABELS:-}" ]; then
                    export PYROSCOPE_LABELS="${PYROSCOPE_LABELS},cluster=${CLUSTER_NAME:-docker-desktop},namespace=${POD_NAMESPACE:-unknown},pod=${POD_NAME:-unknown},node=${NODE_NAME:-unknown}"
                  else
                    export PYROSCOPE_LABELS="cluster=${CLUSTER_NAME:-docker-desktop},namespace=${POD_NAMESPACE:-unknown},pod=${POD_NAME:-unknown},node=${NODE_NAME:-unknown}"
                  fi
                  JAVA_OPTS="${JAVA_OPTS:-} ${JAVAAGENT_ARGS:-}"
                  export JAVA_OPTS
                  echo "inject-java=true; starting with javaagents."
                else
                  echo "inject-java=true but agent jar(s) missing; starting without javaagents."
                fi
              else
                echo "inject-java!=true; starting without javaagents."
              fi
              exec java ${JAVA_OPTS:-} -jar /app/app.jar
          volumeMounts:
            - name: tools
              mountPath: /opt/async-profiler
            - name: otel
              mountPath: /otel
            - name: pyroscope
              mountPath: /pyroscope
          # For async-profiler attach in stricter clusters you may need extra permissions.
          # Docker Desktop usually works without, but keep this handy:
          # securityContext:
          #   allowPrivilegeEscalation: true
          #   capabilities:
          #     add: ["SYS_PTRACE", "PERFMON"]

